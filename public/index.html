<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GPS Carrinho</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
  body, html {
    margin: 0; padding: 0; height: 100%;
    font-family: Arial; background: #111; color: #fff;
  }

  #map { height: 45%; }

  #panel {
    height: 55%;
    background: #181818;
    padding: 20px;
    box-sizing: border-box;
  }

  .row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
    font-size: 18px;
  }

  #wheelBox {
    margin: 0 auto;
    width: 160px;
    height: 160px;
    border-radius: 50%;
    border: 6px solid #444;
    position: relative;
    background: #222;
  }

  #wheelPointer {
    position: absolute;
    width: 6px;
    height: 70px;
    background: red;
    top: 10px;
    left: 50%;
    margin-left: -3px;
    border-radius: 3px;
    transform-origin: bottom center;
    transform: rotate(0deg);
  }

  .center_dot {
    position: absolute;
    width: 20px;
    height: 20px;
    background: #ddd;
    border-radius: 50%;
    top: 70px;
    left: calc(50% - 10px);
  }

  #dirText {
    margin-top: 15px;
    text-align: center;
    font-size: 22px;
  }
</style>
</head>
<body>

<div id="map"></div>

<div id="panel">

  <div class="row">
    <span>Lat:</span> <span id="lat">--</span>
  </div>
  <div class="row">
    <span>Lon:</span> <span id="lon">--</span>
  </div>
  <div class="row">
    <span>Distância:</span> <span id="dist">--</span> m
  </div>
  <div class="row">
    <span>Waypoint:</span> <span id="wp">--</span>
  </div>

  <br>

  <div id="wheelBox">
      <div id="wheelPointer"></div>
      <div class="center_dot"></div>
  </div>

  <div id="dirText">Calculando direção…</div>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>

// ----------------------------------------------
// Funções matemáticas
// ----------------------------------------------
const toRad = v => v * Math.PI/180;
const toDeg = v => v * 180/Math.PI;

function distance(lat1, lon1, lat2, lon2){
    const R = 6371000;
    const φ1 = toRad(lat1);
    const φ2 = toRad(lat2);
    const Δφ = toRad(lat2-lat1);
    const Δλ = toRad(lon2-lon1);

    const a = Math.sin(Δφ/2)**2 +
              Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function bearingTo(lat1, lon1, lat2, lon2){
    lat1 = toRad(lat1);
    lat2 = toRad(lat2);
    const dLon = toRad(lon2-lon1);

    const y = Math.sin(dLon) * Math.cos(lat2);
    const x = Math.cos(lat1)*Math.sin(lat2) -
              Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLon);

    return (toDeg(Math.atan2(y,x)) + 360) % 360;
}

// LERP angular estável
function lerpAngle(a, b, t){
    let diff = ((b - a + 540) % 360) - 180;
    return (a + diff * t + 360) % 360;
}

// ----------------------------------------------
// Variáveis principais
// ----------------------------------------------
let rota = [];
let currentWP = 0;
let map, marker, arrowLine;

let lastLat = null;
let lastLon = null;

let internalHeading = 0;  // direção interna suave
let initializedHeading = false;

// ----------------------------------------------
// Carrega rota
// ----------------------------------------------
fetch('/rota')
    .then(r => r.json())
    .then(data => { rota = data; init(); });

// ----------------------------------------------
// Inicializa mapa
// ----------------------------------------------
function init(){
    map = L.map('map').setView([rota[0].lat, rota[0].lon], 18);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')
        .addTo(map);

    L.polyline(rota.map(p => [p.lat,p.lon]), {color:'blue'}).addTo(map);

    marker = L.marker([rota[0].lat,rota[0].lon]).addTo(map);

    arrowLine = L.polyline([], {color:'red', dashArray:'5,5'}).addTo(map);

    track();
}

// ----------------------------------------------
// Rastreamento GPS + heading interno
// ----------------------------------------------
function track(){
    navigator.geolocation.watchPosition(pos => {

        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        marker.setLatLng([lat, lon]);
        map.setView([lat, lon]);

        document.getElementById('lat').textContent = lat.toFixed(6);
        document.getElementById('lon').textContent = lon.toFixed(6);

        // -------------------------------------
        // Atualiza heading interno baseado no movimento REAL
        // -------------------------------------
        if (lastLat !== null) {

            const distMoved = distance(lastLat, lastLon, lat, lon);

            if (distMoved > 0.5) { // só atualiza se realmente andou
                const rawHeading = bearingTo(lastLat, lastLon, lat, lon);

                if (!initializedHeading) {
                    internalHeading = rawHeading;
                    initializedHeading = true;
                } else {
                    internalHeading = lerpAngle(internalHeading, rawHeading, 0.15);
                }
            }
        }

        lastLat = lat;
        lastLon = lon;

        // -------------------------------------
        // Cálculo de direção para o próximo waypoint
        // -------------------------------------
        const wp = rota[currentWP];
        const dist = distance(lat, lon, wp.lat, wp.lon);

        document.getElementById('dist').textContent = dist.toFixed(1);
        document.getElementById('wp').textContent = currentWP + 1;

        const desiredBearing = bearingTo(lat, lon, wp.lat, wp.lon);

        let delta = desiredBearing - internalHeading;
        if (delta > 180) delta -= 360;
        if (delta < -180) delta += 360;

        // Limita como volante real
        let steering = Math.max(-40, Math.min(40, delta));

        document.getElementById("wheelPointer").style.transform =
            `rotate(${steering}deg)`;

        if (steering > 2)
            document.getElementById("dirText").textContent =
                `Vire para ➜ DIREITA (${steering.toFixed(1)}°)`;
        else if (steering < -2)
            document.getElementById("dirText").textContent =
                `Vire para ⬅ ESQUERDA (${steering.toFixed(1)}°)`;
        else
            document.getElementById("dirText").textContent =
                `Siga em FRENTE (0°)`;

        // seta no mapa
        arrowLine.setLatLngs([
            [lat, lon],
            [wp.lat, wp.lon]
        ]);

        // troca waypoint automaticamente
        if (dist < 10 && currentWP < rota.length - 1)
            currentWP++;

    }, console.warn, {
        enableHighAccuracy:true,
        maximumAge:300,
        timeout:5000
    });
}

</script>
</body>
</html>
