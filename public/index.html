<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GPS Carrinho</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  body, html { margin: 0; padding: 0; height: 100%; font-family: Arial; }
  #map { height: 70%; }
  #info { padding: 10px; }
</style>
</head>
<body>

<h2 style="text-align:center">GPS Carrinho Preview</h2>
<div id="map"></div>
<div id="info">
  <div>Lat: <span id="lat">--</span></div>
  <div>Lon: <span id="lon">--</span></div>
  <div>Distância pro próximo ponto: <span id="dist">--</span> m</div>
  <div>Waypoint atual: <span id="wp">--</span></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>

// --- Variáveis ---
let rota = [];
let currentWP = 0;
let map, marker, polyline;

// Função para calcular distância entre dois pontos em metros
function distance(lat1, lon1, lat2, lon2) {
    const R = 6371000; // raio da Terra em metros
    const φ1 = lat1 * Math.PI/180;
    const φ2 = lat2 * Math.PI/180;
    const Δφ = (lat2-lat1) * Math.PI/180;
    const Δλ = (lon2-lon1) * Math.PI/180;
    const a = Math.sin(Δφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

// Função para pegar rota do backend
fetch('/rota')
  .then(res => res.json())
  .then(data => {
      rota = data;
      initMap();
  });

// --- Inicializa o mapa ---
function initMap() {
    map = L.map('map').setView([rota[0].lat, rota[0].lon], 17);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
    }).addTo(map);

    // Mostra toda a rota
    const latlngs = rota.map(p => [p.lat, p.lon]);
    polyline = L.polyline(latlngs, {color: 'blue'}).addTo(map);

    // Marcador inicial
    marker = L.marker([rota[0].lat, rota[0].lon]).addTo(map);

    // Começa rastrear posição
    trackPosition();
}

// --- Rastreia posição do usuário ---
function trackPosition() {
    if (!navigator.geolocation) {
        alert("Geolocalização não suportada!");
        return;
    }

    navigator.geolocation.watchPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        // Atualiza marcador
        marker.setLatLng([lat, lon]);
        map.setView([lat, lon]);

        // Atualiza info
        document.getElementById('lat').textContent = lat.toFixed(6);
        document.getElementById('lon').textContent = lon.toFixed(6);

        // Calcula distância pro waypoint atual
        if (rota.length > 0 && currentWP < rota.length) {
            const dist = distance(lat, lon, rota[currentWP].lat, rota[currentWP].lon);
            document.getElementById('dist').textContent = dist.toFixed(1);
            document.getElementById('wp').textContent = currentWP + 1;

            // Se estiver a menos de 10m, passa pro próximo waypoint
            if (dist < 10 && currentWP < rota.length - 1) {
                currentWP++;
            }
        }
    }, err => {
        console.error(err);
    }, {
        enableHighAccuracy: true,
        maximumAge: 1000,
        timeout: 5000
    });
}

</script>
</body>
</html>
